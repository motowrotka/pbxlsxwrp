name: Build xlsxwriter PowerBuilder Wrapper (Simple Static)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
    
    - name: Download and extract zlib
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/madler/zlib/archive/refs/tags/v1.3.1.tar.gz" -OutFile "zlib.tar.gz"
        tar -xzf zlib.tar.gz
    
    - name: Build zlib static library
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cd zlib-1.3.1
        nmake -f win32/Makefile.msc zlib.lib
        cd ..
    
    - name: Download and extract libxlsxwriter
      shell: powershell
      run: |
        git clone --depth 1 --branch RELEASE_1.1.5 https://github.com/jmcnamara/libxlsxwriter.git
    
    - name: Create libxlsxwriter CMakeLists with static build
      shell: powershell
      run: |
        cd libxlsxwriter
        mkdir build
        cd build
    
    - name: Configure libxlsxwriter
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cd libxlsxwriter\build
        cmake -G "NMake Makefiles" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=OFF ^
          -DBUILD_EXAMPLES=OFF ^
          -DBUILD_TESTS=OFF ^
          -DUSE_STANDARD_TMPFILE=ON ^
          -DZLIB_INCLUDE_DIR="%GITHUB_WORKSPACE%\zlib-1.3.1" ^
          -DZLIB_LIBRARY="%GITHUB_WORKSPACE%\zlib-1.3.1\zlib.lib" ^
          ..
    
    - name: Build libxlsxwriter
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cd libxlsxwriter\build
        nmake
    
    - name: Build wrapper DLL (static linking)
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
        cl /LD /MT /O2 ^
          /DUSE_STANDARD_TMPFILE ^
          /I"libxlsxwriter\include" ^
          /I"zlib-1.3.1" ^
          xlsxwriter_pb_wrapper.cpp ^
          /link ^
          /LIBPATH:"libxlsxwriter\build" ^
          /LIBPATH:"zlib-1.3.1" ^
          xlsxwriter.lib zlib.lib ^
          Advapi32.lib ^
          /OUT:xlsxwriter_pb.dll ^
          /DEF:xlsxwriter_pb.def
    
    - name: Verify DLL was created
      shell: cmd
      run: |
        dir xlsxwriter_pb.dll
        dumpbin /exports xlsxwriter_pb.dll
    
    - name: Upload DLL artifact
      uses: actions/upload-artifact@v4
      with:
        name: xlsxwriter_pb_dll
        path: |
          xlsxwriter_pb.dll
          xlsxwriter_pb.lib
          xlsxwriter_pb.exp
        retention-days: 30
    
    - name: Create Release on Tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          xlsxwriter_pb.dll
          xlsxwriter_pb.lib
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
